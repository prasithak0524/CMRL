<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Generate Reports</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafc;
      margin: 0;
      padding: 0;
    }

    /* Navbar */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      padding: 12px 30px;
      border-bottom: 1px solid #ddd;
    }

    .navbar-left {
      font-weight: bold;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .navbar-right a {
      text-decoration: none;
      color: #333;
      font-size: 14px;
    }

    .navbar-right a:hover {
      color: #007bff;
    }

    .navbar-right i {
      font-size: 16px;
      color: #333;
      cursor: pointer;
    }

    /* Page Heading */
    .page-title {
      font-size: 30px;
      font-weight: bold;
      margin: 30px auto 5px;
      max-width: 900px;
      padding-left: 5px;
    }

    .subtitle {
      color: #555;
      margin: 0 auto 20px;
      max-width: 900px;
      padding-left: 5px;
      font-size: 14px;
    }

    /* Container Box */
    .container {
      max-width: 900px;
      margin: 0 auto 40px;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .section-title {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 16px;
    }

    .section-subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 15px;
    }

    /* Report Type Boxes */
    .report-type-options {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .report-box {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: 0.2s;
    }

    .report-box:hover {
      background: #eef6ff;
      border-color: #007bff;
    }

    .report-box input {
      margin: 0;
      cursor: pointer;
    }

    .report-box label {
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
    }

    /* Parameters */
    .form-group {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      margin-bottom: 6px;
      color: #444;
    }

    .form-group input, 
    .form-group select {
      padding: 8px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    /* Actions */
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-outline {
      background: #fff;
      border: 1px solid #ccc;
    }

    .btn-primary {
      background: #007bff;
      color: white;
      font-weight: bold;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    /* Report Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table th, table td {
      padding: 8px 12px;
      border: 1px solid #ccc;
      text-align: left;
      font-size: 13px;
    }

    table th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

  <!-- Top Navbar -->
  <div class="navbar">
    <div class="navbar-left">
      <i class="fa-solid fa-cube"></i> HR Management
    </div>
    <div class="navbar-right">
      <a href="/">Dashboard</a>
      <a href="/attendance">Attendance</a>
      <a href="/leave">Leave</a>
      <a href="/holidays">Holidays</a>
      <a href="/reports">Reports</a>
      <i class="fa-regular fa-bell"></i>
    </div>
  </div>

  <!-- Page Title -->
  <div class="page-title">Generate Reports</div>
  <p class="subtitle">Select a report type and specify parameters to generate and export.</p>

  <!-- Report Content -->
  <div class="container">
    <!-- Report Type -->
    <div class="section-title">Report Type</div>
    <div class="section-subtitle">Choose the type of report you'd like to generate</div>

    <div class="report-type-options">
      <div class="report-box">
        <input type="radio" name="reportType" value="employee" checked>
        <label>Employee Data Report</label>
      </div>
      <div class="report-box">
        <input type="radio" name="reportType" value="leave">
        <label>Leave Summary Report</label>
      </div>
    </div>

    <!-- Parameters -->
    <div class="section-title">Parameters</div>
    <div class="form-group">
      <div style="flex:1;">
        <label>Department</label>
        <select id="department">
          <option value="all">All Departments</option>
          <option value="HR">HR</option>
          <option value="IT">IT</option>
          <option value="Finance">Finance</option>
        </select>
      </div>
      <div style="flex:1;">
        <label>Employee</label>
        <select id="empId">
          <option value="">All Employees</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <div style="flex:1;">
        <label>Start Date</label>
        <input type="date" id="startDate" value="2025-01-01">
      </div>
      <div style="flex:1;">
        <label>End Date</label>
        <input type="date" id="endDate" value="2025-12-31">
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn btn-outline" onclick="exportReport()">Export</button>
      <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
    </div>

    <!-- Report Output -->
    <div id="reportOutput"></div>
  </div>

<script>
async function loadEmployees() {
  try {
    const res = await fetch('http://localhost:3000/api/employees'); 
    const employees = await res.json();
    const empSelect = document.getElementById("empId");
    employees.forEach(emp => {
      const option = document.createElement("option");
      option.value = emp.EmpId;
      option.text = `${emp.EmpId} - ${emp.Name}`;
      empSelect.appendChild(option);
    });
  } catch(err) {
    console.error("Failed to load employees:", err);
  }
}

loadEmployees();

async function generateReport() {
  const reportType = document.querySelector('input[name="reportType"]:checked').value;
  const department = document.getElementById("department").value.trim();
  const empId = document.getElementById("empId").value.trim();

  let url = reportType === 'employee' 
            ? 'http://localhost:3000/api/employee-report' 
            : 'http://localhost:3000/api/leave-summary';

  if(reportType === 'leave') {
    const params = new URLSearchParams();
    if(empId) params.append("empId", empId);
    url += `?${params.toString()}`;
  }

  try {
    let data = await (await fetch(url)).json();
    if (!Array.isArray(data)) data = [];

    if(reportType === 'leave') {
      data = data.map(l => ({
        EmpId: l.EmpId,
        employeeName: l.employeeName || l.Name,
        leaveType: l.leaveType || l.leave_type,
        start_date: l.start_date || l.StartDate,
        end_date: l.end_date || l.EndDate,
        numDays: l.number_of_days || l.numDays || 0,
        status: l.status || l.Status || "Pending"
      }));
    }

    if(department !== 'all' && reportType === 'employee') {
      data = data.filter(e => e.Dept && e.Dept.trim().toLowerCase() === department.toLowerCase().trim());
    }

    renderReportTable(data, reportType);

  } catch(err) {
    console.error(err);
    alert("Failed to fetch report data");
  }
}

function renderReportTable(data, type) {
  const container = document.getElementById("reportOutput");
  if(!data || data.length === 0) {
    container.innerHTML = "<p>No data found for selected filters.</p>";
    return;
  }

  let html = '<table><thead><tr>';
  if(type === 'employee') {
    html += '<th>EmpId</th><th>Name</th><th>Department</th><th>Designation</th><th>Active</th></tr></thead><tbody>';
    data.forEach(e => {
      html += `<tr>
        <td>${e.EmpId}</td>
        <td>${e.Name}</td>
        <td>${e.Dept}</td>
        <td>${e.Design}</td>
        <td>${e.Active ? "Yes" : "No"}</td>
      </tr>`;
    });
  } else {
    html += '<th>EmpId</th><th>Name</th><th>Leave Type</th><th>Start Date</th><th>End Date</th><th>Days</th><th>Status</th></tr></thead><tbody>';
    data.forEach(l => {
      html += `<tr>
        <td>${l.EmpId}</td>
        <td>${l.employeeName}</td>
        <td>${l.leaveType}</td>
        <td>${new Date(l.start_date).toISOString().split('T')[0]}</td>
        <td>${new Date(l.end_date).toISOString().split('T')[0]}</td>
        <td>${l.numDays}</td>
        <td>${l.status}</td>
      </tr>`;
    });
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

function exportReport() {
  const table = document.querySelector("#reportOutput table");
  if(!table){
    alert("No report data to export.");
    return;
  }

  let csv = [];
  const rows = table.querySelectorAll("tr");
  rows.forEach(row => {
    const cols = row.querySelectorAll("th, td");
    const rowData = [];
    cols.forEach(col => {
      let text = col.innerText.replace(/"/g, '""');
      rowData.push(`"${text}"`);
    });
    csv.push(rowData.join(","));
  });

  const csvString = csv.join("\n");
  const blob = new Blob([csvString], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;

  const reportType = document.querySelector('input[name="reportType"]:checked').value;
  const dateStr = new Date().toISOString().split('T')[0];
  a.download = `${reportType}-report-${dateStr}.csv`;

  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
